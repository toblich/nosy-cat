version: "3.7"

x-base-environment: &base-environment
  INGRESS_HOST: ingress
  INGRESS_PORT: 3000

x-base-networks: &base-networks
  - nosy-cat_nosy-cat

x-base-service: &base-service
  build:
    context: .
  volumes:
    - "./routers:/project/app/routers"
    - "./nodemon.json:/project/app/nodemon.json"
    - "./tsconfig.json:/project/app/tsconfig.json"
    - "./recorder.ts:/project/app/recorder.ts"
    - "./server.ts:/project/app/server.ts"
    - "./servicesFetch.ts:/project/app/servicesFetch.ts"
  networks: *base-networks

services:
  xapi:
    <<: *base-service
    links:
      - redis
      - iam
    ports:
      - "7000:80"
    environment:
      <<: *base-environment
      NAME: xapi

  iam:
    <<: *base-service
    links:
      - postgres
    environment:
      <<: *base-environment
      NAME: iam

  inventory:
    <<: *base-service
    environment:
      <<: *base-environment
      NAME: inventory

  billing:
    <<: *base-service
    environment:
      <<: *base-environment
      NAME: billing

  payments:
    <<: *base-service
    environment:
      <<: *base-environment
      NAME: payments

  redis:
    image: redis
    networks: *base-networks

  postgres:
    image: postgres:11
    networks: *base-networks
    environment:
      POSTGRES_HOST_AUTH_METHOD: trust

networks:
  nosy-cat_nosy-cat:
    external: true
